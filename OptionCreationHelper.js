const ethers = require('ethers');
const BigNumber = require('bignumber.js');
require('dotenv').config();
const fs = require('fs');

const provider = new ethers.providers.JsonRpcProvider(process.env.RPC_URL);
const adminWallet = new ethers.Wallet(process.env.ADMIN_KEY, provider);

const optionFactoryAddress = '0xDF2F0a47BDc94e221D6bC396Bc43dB932364cF4C';

let constructorParameters = [
  {
    "Underlying asset": "Komodo Corn (kZC=F)",
    "Strike asset": "USDC",
    "Strike price": 535000000,
    "Expiration date": 1640995199,
    "Symbol": "kZC=F:USDC",
    "Option Type": "Call (1)",
    "Underlying Address (Kovan)": "0xDB7afCc07D54aAf5C8ec618EbB4843f00Eec4003",
    "Strike Address (Kovan)": "0xe22da380ee6b445bb8273c81944adeb6e8450422",
    "Option Address (Kovan)": "",
    "Pool Address (Kovan)": ""
  },
  {
    "Underlying asset": "Komodo Corn (kZC=F)",
    "Strike asset": "USDC",
    "Strike price": 500000000,
    "Expiration date": 1640995199,
    "Symbol": "kZC=F:USDC",
    "Option Type": "Call (1)",
    "Underlying Address (Kovan)": "0xDB7afCc07D54aAf5C8ec618EbB4843f00Eec4003",
    "Strike Address (Kovan)": "0xe22da380ee6b445bb8273c81944adeb6e8450422",
    "Option Address (Kovan)": "",
    "Pool Address (Kovan)": ""
  },
  {
    "Underlying asset": "Komodo Corn (kZC=F)",
    "Strike asset": "USDC",
    "Strike price": 475000000,
    "Expiration date": 1638316799,
    "Symbol": "kZC=F:USDC",
    "Option Type": "Call (1)",
    "Underlying Address (Kovan)": "0xDB7afCc07D54aAf5C8ec618EbB4843f00Eec4003",
    "Strike Address (Kovan)": "0xe22da380ee6b445bb8273c81944adeb6e8450422",
    "Option Address (Kovan)": "",
    "Pool Address (Kovan)": ""
  },
]

const factoryABI = [  {    "inputs": [      {        "internalType": "address",        "name": "wethAddress",        "type": "address"      },      {        "internalType": "address",        "name": "PodPutBuilder",        "type": "address"      },      {        "internalType": "address",        "name": "WPodPutBuilder",        "type": "address"      },      {        "internalType": "address",        "name": "PodCallBuilder",        "type": "address"      },      {        "internalType": "address",        "name": "WPodCallBuilder",        "type": "address"      },      {        "internalType": "address",        "name": "ConfigurationManager",        "type": "address"      }    ],    "stateMutability": "nonpayable",    "type": "constructor"  },  {    "anonymous": false,    "inputs": [      {        "indexed": true,        "internalType": "address",        "name": "deployer",        "type": "address"      },      {        "indexed": false,        "internalType": "address",        "name": "option",        "type": "address"      },      {        "indexed": false,        "internalType": "enum IPodOption.OptionType",        "name": "_optionType",        "type": "uint8"      },      {        "indexed": false,        "internalType": "enum IPodOption.ExerciseType",        "name": "_exerciseType",        "type": "uint8"      },      {        "indexed": false,        "internalType": "address",        "name": "underlyingAsset",        "type": "address"      },      {        "indexed": false,        "internalType": "address",        "name": "strikeAsset",        "type": "address"      },      {        "indexed": false,        "internalType": "uint256",        "name": "strikePrice",        "type": "uint256"      },      {        "indexed": false,        "internalType": "uint256",        "name": "expiration",        "type": "uint256"      },      {        "indexed": false,        "internalType": "uint256",        "name": "exerciseWindowSize",        "type": "uint256"      }    ],    "name": "OptionCreated",    "type": "event"  },  {    "inputs": [],    "name": "WETH_ADDRESS",    "outputs": [      {        "internalType": "address",        "name": "",        "type": "address"      }    ],    "stateMutability": "view",    "type": "function"  },  {    "inputs": [],    "name": "configurationManager",    "outputs": [      {        "internalType": "contract IConfigurationManager",        "name": "",        "type": "address"      }    ],    "stateMutability": "view",    "type": "function"  },  {    "inputs": [      {        "internalType": "string",        "name": "name",        "type": "string"      },      {        "internalType": "string",        "name": "symbol",        "type": "string"      },      {        "internalType": "enum IPodOption.OptionType",        "name": "optionType",        "type": "uint8"      },      {        "internalType": "enum IPodOption.ExerciseType",        "name": "exerciseType",        "type": "uint8"      },      {        "internalType": "address",        "name": "underlyingAsset",        "type": "address"      },      {        "internalType": "address",        "name": "strikeAsset",        "type": "address"      },      {        "internalType": "uint256",        "name": "strikePrice",        "type": "uint256"      },      {        "internalType": "uint256",        "name": "expiration",        "type": "uint256"      },      {        "internalType": "uint256",        "name": "exerciseWindowSize",        "type": "uint256"      },      {        "internalType": "bool",        "name": "isAave",        "type": "bool"      }    ],    "name": "createOption",    "outputs": [      {        "internalType": "address",        "name": "",        "type": "address"      }    ],    "stateMutability": "nonpayable",    "type": "function"  },  {    "inputs": [],    "name": "podCallBuilder",    "outputs": [      {        "internalType": "contract IOptionBuilder",        "name": "",        "type": "address"      }    ],    "stateMutability": "view",    "type": "function"  },  {    "inputs": [],    "name": "podPutBuilder",    "outputs": [      {        "internalType": "contract IOptionBuilder",        "name": "",        "type": "address"      }    ],    "stateMutability": "view",    "type": "function"  },  {    "inputs": [],    "name": "wPodCallBuilder",    "outputs": [      {        "internalType": "contract IOptionBuilder",        "name": "",        "type": "address"      }    ],    "stateMutability": "view",    "type": "function"  },  {    "inputs": [],    "name": "wPodPutBuilder",    "outputs": [      {        "internalType": "contract IOptionBuilder",        "name": "",        "type": "address"      }    ],    "stateMutability": "view",    "type": "function"  }]

const optionABI = [  {    "inputs": [      {        "internalType": "string",        "name": "name",        "type": "string"      },      {        "internalType": "string",        "name": "symbol",        "type": "string"      },      {        "internalType": "enum IPodOption.ExerciseType",        "name": "exerciseType",        "type": "uint8"      },      {        "internalType": "address",        "name": "underlyingAsset",        "type": "address"      },      {        "internalType": "address",        "name": "strikeAsset",        "type": "address"      },      {        "internalType": "uint256",        "name": "strikePrice",        "type": "uint256"      },      {        "internalType": "uint256",        "name": "expiration",        "type": "uint256"      },      {        "internalType": "uint256",        "name": "exerciseWindowSize",        "type": "uint256"      },      {        "internalType": "contract IConfigurationManager",        "name": "configurationManager",        "type": "address"      }    ],    "stateMutability": "nonpayable",    "type": "constructor"  },  {    "anonymous": false,    "inputs": [      {        "indexed": true,        "internalType": "address",        "name": "owner",        "type": "address"      },      {        "indexed": true,        "internalType": "address",        "name": "spender",        "type": "address"      },      {        "indexed": false,        "internalType": "uint256",        "name": "value",        "type": "uint256"      }    ],    "name": "Approval",    "type": "event"  },  {    "anonymous": false,    "inputs": [      {        "indexed": true,        "internalType": "address",        "name": "exerciser",        "type": "address"      },      {        "indexed": false,        "internalType": "uint256",        "name": "amount",        "type": "uint256"      }    ],    "name": "Exercise",    "type": "event"  },  {    "anonymous": false,    "inputs": [      {        "indexed": true,        "internalType": "address",        "name": "minter",        "type": "address"      },      {        "indexed": false,        "internalType": "uint256",        "name": "amount",        "type": "uint256"      }    ],    "name": "Mint",    "type": "event"  },  {    "anonymous": false,    "inputs": [      {        "indexed": true,        "internalType": "address",        "name": "from",        "type": "address"      },      {        "indexed": true,        "internalType": "address",        "name": "to",        "type": "address"      },      {        "indexed": false,        "internalType": "uint256",        "name": "value",        "type": "uint256"      }    ],    "name": "Transfer",    "type": "event"  },  {    "anonymous": false,    "inputs": [      {        "indexed": true,        "internalType": "address",        "name": "minter",        "type": "address"      },      {        "indexed": false,        "internalType": "uint256",        "name": "optionAmount",        "type": "uint256"      },      {        "indexed": false,        "internalType": "uint256",        "name": "strikeAmount",        "type": "uint256"      },      {        "indexed": false,        "internalType": "uint256",        "name": "underlyingAmount",        "type": "uint256"      }    ],    "name": "Unmint",    "type": "event"  },  {    "anonymous": false,    "inputs": [      {        "indexed": true,        "internalType": "address",        "name": "minter",        "type": "address"      },      {        "indexed": false,        "internalType": "uint256",        "name": "strikeAmount",        "type": "uint256"      },      {        "indexed": false,        "internalType": "uint256",        "name": "underlyingAmount",        "type": "uint256"      }    ],    "name": "Withdraw",    "type": "event"  },  {    "inputs": [],    "name": "MIN_EXERCISE_WINDOW_SIZE",    "outputs": [      {        "internalType": "uint256",        "name": "",        "type": "uint256"      }    ],    "stateMutability": "view",    "type": "function"  },  {    "inputs": [      {        "internalType": "address",        "name": "owner",        "type": "address"      },      {        "internalType": "address",        "name": "spender",        "type": "address"      }    ],    "name": "allowance",    "outputs": [      {        "internalType": "uint256",        "name": "",        "type": "uint256"      }    ],    "stateMutability": "view",    "type": "function"  },  {    "inputs": [      {        "internalType": "address",        "name": "spender",        "type": "address"      },      {        "internalType": "uint256",        "name": "amount",        "type": "uint256"      }    ],    "name": "approve",    "outputs": [      {        "internalType": "bool",        "name": "",        "type": "bool"      }    ],    "stateMutability": "nonpayable",    "type": "function"  },  {    "inputs": [      {        "internalType": "address",        "name": "account",        "type": "address"      }    ],    "name": "balanceOf",    "outputs": [      {        "internalType": "uint256",        "name": "",        "type": "uint256"      }    ],    "stateMutability": "view",    "type": "function"  },  {    "inputs": [],    "name": "capSize",    "outputs": [      {        "internalType": "uint256",        "name": "",        "type": "uint256"      }    ],    "stateMutability": "view",    "type": "function"  },  {    "inputs": [],    "name": "configurationManager",    "outputs": [      {        "internalType": "contract IConfigurationManager",        "name": "",        "type": "address"      }    ],    "stateMutability": "view",    "type": "function"  },  {    "inputs": [],    "name": "decimals",    "outputs": [      {        "internalType": "uint8",        "name": "",        "type": "uint8"      }    ],    "stateMutability": "view",    "type": "function"  },  {    "inputs": [      {        "internalType": "address",        "name": "spender",        "type": "address"      },      {        "internalType": "uint256",        "name": "subtractedValue",        "type": "uint256"      }    ],    "name": "decreaseAllowance",    "outputs": [      {        "internalType": "bool",        "name": "",        "type": "bool"      }    ],    "stateMutability": "nonpayable",    "type": "function"  },  {    "inputs": [      {        "internalType": "uint256",        "name": "amountOfOptions",        "type": "uint256"      }    ],    "name": "exercise",    "outputs": [],    "stateMutability": "nonpayable",    "type": "function"  },  {    "inputs": [],    "name": "exerciseType",    "outputs": [      {        "internalType": "enum IPodOption.ExerciseType",        "name": "",        "type": "uint8"      }    ],    "stateMutability": "view",    "type": "function"  },  {    "inputs": [],    "name": "expiration",    "outputs": [      {        "internalType": "uint256",        "name": "",        "type": "uint256"      }    ],    "stateMutability": "view",    "type": "function"  },  {    "inputs": [      {        "internalType": "address",        "name": "owner",        "type": "address"      }    ],    "name": "getSellerWithdrawAmounts",    "outputs": [      {        "internalType": "uint256",        "name": "strikeAmount",        "type": "uint256"      },      {        "internalType": "uint256",        "name": "underlyingAmount",        "type": "uint256"      }    ],    "stateMutability": "view",    "type": "function"  },  {    "inputs": [],    "name": "hasExpired",    "outputs": [      {        "internalType": "bool",        "name": "",        "type": "bool"      }    ],    "stateMutability": "view",    "type": "function"  },  {    "inputs": [      {        "internalType": "address",        "name": "spender",        "type": "address"      },      {        "internalType": "uint256",        "name": "addedValue",        "type": "uint256"      }    ],    "name": "increaseAllowance",    "outputs": [      {        "internalType": "bool",        "name": "",        "type": "bool"      }    ],    "stateMutability": "nonpayable",    "type": "function"  },  {    "inputs": [],    "name": "isExerciseWindow",    "outputs": [      {        "internalType": "bool",        "name": "",        "type": "bool"      }    ],    "stateMutability": "view",    "type": "function"  },  {    "inputs": [],    "name": "isTradeWindow",    "outputs": [      {        "internalType": "bool",        "name": "",        "type": "bool"      }    ],    "stateMutability": "view",    "type": "function"  },  {    "inputs": [],    "name": "isWithdrawWindow",    "outputs": [      {        "internalType": "bool",        "name": "",        "type": "bool"      }    ],    "stateMutability": "view",    "type": "function"  },  {    "inputs": [      {        "internalType": "uint256",        "name": "amountOfOptions",        "type": "uint256"      },      {        "internalType": "address",        "name": "owner",        "type": "address"      }    ],    "name": "mint",    "outputs": [],    "stateMutability": "nonpayable",    "type": "function"  },  {    "inputs": [      {        "internalType": "address",        "name": "",        "type": "address"      }    ],    "name": "mintedOptions",    "outputs": [      {        "internalType": "uint256",        "name": "",        "type": "uint256"      }    ],    "stateMutability": "view",    "type": "function"  },  {    "inputs": [],    "name": "name",    "outputs": [      {        "internalType": "string",        "name": "",        "type": "string"      }    ],    "stateMutability": "view",    "type": "function"  },  {    "inputs": [],    "name": "optionType",    "outputs": [      {        "internalType": "enum IPodOption.OptionType",        "name": "",        "type": "uint8"      }    ],    "stateMutability": "view",    "type": "function"  },  {    "inputs": [      {        "internalType": "address",        "name": "",        "type": "address"      }    ],    "name": "shares",    "outputs": [      {        "internalType": "uint256",        "name": "",        "type": "uint256"      }    ],    "stateMutability": "view",    "type": "function"  },  {    "inputs": [],    "name": "startOfExerciseWindow",    "outputs": [      {        "internalType": "uint256",        "name": "",        "type": "uint256"      }    ],    "stateMutability": "view",    "type": "function"  },  {    "inputs": [],    "name": "strikeAsset",    "outputs": [      {        "internalType": "address",        "name": "",        "type": "address"      }    ],    "stateMutability": "view",    "type": "function"  },  {    "inputs": [],    "name": "strikeAssetDecimals",    "outputs": [      {        "internalType": "uint8",        "name": "",        "type": "uint8"      }    ],    "stateMutability": "view",    "type": "function"  },  {    "inputs": [],    "name": "strikePrice",    "outputs": [      {        "internalType": "uint256",        "name": "",        "type": "uint256"      }    ],    "stateMutability": "view",    "type": "function"  },  {    "inputs": [],    "name": "strikePriceDecimals",    "outputs": [      {        "internalType": "uint8",        "name": "",        "type": "uint8"      }    ],    "stateMutability": "view",    "type": "function"  },  {    "inputs": [],    "name": "strikeReserves",    "outputs": [      {        "internalType": "uint256",        "name": "",        "type": "uint256"      }    ],    "stateMutability": "view",    "type": "function"  },  {    "inputs": [      {        "internalType": "uint256",        "name": "amountOfOptions",        "type": "uint256"      }    ],    "name": "strikeToTransfer",    "outputs": [      {        "internalType": "uint256",        "name": "",        "type": "uint256"      }    ],    "stateMutability": "view",    "type": "function"  },  {    "inputs": [],    "name": "symbol",    "outputs": [      {        "internalType": "string",        "name": "",        "type": "string"      }    ],    "stateMutability": "view",    "type": "function"  },  {    "inputs": [],    "name": "totalShares",    "outputs": [      {        "internalType": "uint256",        "name": "",        "type": "uint256"      }    ],    "stateMutability": "view",    "type": "function"  },  {    "inputs": [],    "name": "totalSupply",    "outputs": [      {        "internalType": "uint256",        "name": "",        "type": "uint256"      }    ],    "stateMutability": "view",    "type": "function"  },  {    "inputs": [      {        "internalType": "address",        "name": "recipient",        "type": "address"      },      {        "internalType": "uint256",        "name": "amount",        "type": "uint256"      }    ],    "name": "transfer",    "outputs": [      {        "internalType": "bool",        "name": "",        "type": "bool"      }    ],    "stateMutability": "nonpayable",    "type": "function"  },  {    "inputs": [      {        "internalType": "address",        "name": "sender",        "type": "address"      },      {        "internalType": "address",        "name": "recipient",        "type": "address"      },      {        "internalType": "uint256",        "name": "amount",        "type": "uint256"      }    ],    "name": "transferFrom",    "outputs": [      {        "internalType": "bool",        "name": "",        "type": "bool"      }    ],    "stateMutability": "nonpayable",    "type": "function"  },  {    "inputs": [],    "name": "underlyingAsset",    "outputs": [      {        "internalType": "address",        "name": "",        "type": "address"      }    ],    "stateMutability": "view",    "type": "function"  },  {    "inputs": [],    "name": "underlyingAssetDecimals",    "outputs": [      {        "internalType": "uint8",        "name": "",        "type": "uint8"      }    ],    "stateMutability": "view",    "type": "function"  },  {    "inputs": [],    "name": "underlyingReserves",    "outputs": [      {        "internalType": "uint256",        "name": "",        "type": "uint256"      }    ],    "stateMutability": "view",    "type": "function"  },  {    "inputs": [      {        "internalType": "uint256",        "name": "amountOfOptions",        "type": "uint256"      }    ],    "name": "unmint",    "outputs": [],    "stateMutability": "nonpayable",    "type": "function"  },  {    "inputs": [],    "name": "withdraw",    "outputs": [],    "stateMutability": "nonpayable",    "type": "function"  }]

const erc20ABI = [  {    "inputs": [      {        "internalType": "string",        "name": "name",        "type": "string"      },      {        "internalType": "string",        "name": "symbol",        "type": "string"      }    ],    "stateMutability": "nonpayable",    "type": "constructor"  },  {    "anonymous": false,    "inputs": [      {        "indexed": true,        "internalType": "address",        "name": "owner",        "type": "address"      },      {        "indexed": true,        "internalType": "address",        "name": "spender",        "type": "address"      },      {        "indexed": false,        "internalType": "uint256",        "name": "value",        "type": "uint256"      }    ],    "name": "Approval",    "type": "event"  },  {    "anonymous": false,    "inputs": [      {        "indexed": true,        "internalType": "address",        "name": "from",        "type": "address"      },      {        "indexed": true,        "internalType": "address",        "name": "to",        "type": "address"      },      {        "indexed": false,        "internalType": "uint256",        "name": "value",        "type": "uint256"      }    ],    "name": "Transfer",    "type": "event"  },  {    "inputs": [      {        "internalType": "address",        "name": "owner",        "type": "address"      },      {        "internalType": "address",        "name": "spender",        "type": "address"      }    ],    "name": "allowance",    "outputs": [      {        "internalType": "uint256",        "name": "",        "type": "uint256"      }    ],    "stateMutability": "view",    "type": "function"  },  {    "inputs": [      {        "internalType": "address",        "name": "spender",        "type": "address"      },      {        "internalType": "uint256",        "name": "amount",        "type": "uint256"      }    ],    "name": "approve",    "outputs": [      {        "internalType": "bool",        "name": "",        "type": "bool"      }    ],    "stateMutability": "nonpayable",    "type": "function"  },  {    "inputs": [      {        "internalType": "address",        "name": "account",        "type": "address"      }    ],    "name": "balanceOf",    "outputs": [      {        "internalType": "uint256",        "name": "",        "type": "uint256"      }    ],    "stateMutability": "view",    "type": "function"  },  {    "inputs": [],    "name": "decimals",    "outputs": [      {        "internalType": "uint8",        "name": "",        "type": "uint8"      }    ],    "stateMutability": "view",    "type": "function"  },  {    "inputs": [      {        "internalType": "address",        "name": "spender",        "type": "address"      },      {        "internalType": "uint256",        "name": "subtractedValue",        "type": "uint256"      }    ],    "name": "decreaseAllowance",    "outputs": [      {        "internalType": "bool",        "name": "",        "type": "bool"      }    ],    "stateMutability": "nonpayable",    "type": "function"  },  {    "inputs": [      {        "internalType": "address",        "name": "spender",        "type": "address"      },      {        "internalType": "uint256",        "name": "addedValue",        "type": "uint256"      }    ],    "name": "increaseAllowance",    "outputs": [      {        "internalType": "bool",        "name": "",        "type": "bool"      }    ],    "stateMutability": "nonpayable",    "type": "function"  },  {    "inputs": [],    "name": "name",    "outputs": [      {        "internalType": "string",        "name": "",        "type": "string"      }    ],    "stateMutability": "view",    "type": "function"  },  {    "inputs": [],    "name": "symbol",    "outputs": [      {        "internalType": "string",        "name": "",        "type": "string"      }    ],    "stateMutability": "view",    "type": "function"  },  {    "inputs": [],    "name": "totalSupply",    "outputs": [      {        "internalType": "uint256",        "name": "",        "type": "uint256"      }    ],    "stateMutability": "view",    "type": "function"  },  {    "inputs": [      {        "internalType": "address",        "name": "recipient",        "type": "address"      },      {        "internalType": "uint256",        "name": "amount",        "type": "uint256"      }    ],    "name": "transfer",    "outputs": [      {        "internalType": "bool",        "name": "",        "type": "bool"      }    ],    "stateMutability": "nonpayable",    "type": "function"  },  {    "inputs": [      {        "internalType": "address",        "name": "sender",        "type": "address"      },      {        "internalType": "address",        "name": "recipient",        "type": "address"      },      {        "internalType": "uint256",        "name": "amount",        "type": "uint256"      }    ],    "name": "transferFrom",    "outputs": [      {        "internalType": "bool",        "name": "",        "type": "bool"      }    ],    "stateMutability": "nonpayable",    "type": "function"  }]


const start = async () => {
	const optionFactory = new ethers.Contract(optionFactoryAddress, factoryABI, adminWallet)

	for (var i=0; i< constructorParameters.length; i++){
		const newOption = await optionFactory.createOption(
			"PodCall " + constructorParameters[i]["Underlying asset"]+" "+(parseFloat(constructorParameters[i]["Strike price"])/1000000), // assuming USDC 6 decimals
			constructorParameters[i]["Symbol"],
			1,
			0,
      constructorParameters[i]["Underlying Address (Kovan)"],
			constructorParameters[i]["Strike Address (Kovan)"],
			parseFloat(constructorParameters[i]["Strike price"]),
			constructorParameters[i]["Expiration date"],
			86401,
      false,
			{
				gasPrice:10000000000,
				gasLimit:12500000
			}
		);


    const finishOption = await newOption.wait();

    let iface = new ethers.utils.Interface(factoryABI);

    console.log("Created Option: ", iface.parseLog(finishOption.logs[0]).args.option);
    const option = iface.parseLog(finishOption.logs[0]).args.option;
    constructorParameters[i]["Option Address (Kovan)"] = option;

    const underlyingContract = new ethers.Contract(constructorParameters[i]["Underlying Address (Kovan)"], erc20ABI, adminWallet);

    const underlyingApproval = await underlyingContract.approve(option, ethers.constants.MaxUint256,  {
      gasPrice:10000000000,
      gasLimit:1250000
    });

    const waitForUnderlyingApproval = await underlyingApproval.wait();
    console.log("approved underlying for mint...")

    const optionContract = new ethers.Contract(option, optionABI, adminWallet);
    const mintOption = await optionContract.mint(
      "5000000000000000000", //amount of underlying
      "", // receiver wallet address here
      {
        gasPrice:10000000000,
        gasLimit:1250000
      });
    const waitForMint = await mintOption.wait();
    console.log("Minted options")

    fs.writeFileSync("example.json", option);

	}

  fs.writeFileSync("optionsResults.json", JSON.stringify(constructorParameters));
}


start();

